<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="title">Verificação de Commmits</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="formulario">
        <div class="container">
            <form>
                <label class="label"><b>Repositório</b></label>
                <input class="inputFullSize" type="text" id="repositorioInput" /><br /><br />

                <label class="label"><b>Data Inicial</b></label>
                <input class="inputFullSize" type="date" id="dataInicialInput"><br /><br />

                <label class="label"><b>Data Final</b></label>
                <input class="inputFullSize" type="date" id="dataFinalInput"><br /><br />

                <input class="btn-submit" type="submit" value="Pesquisar">
                <div class="resultadosPesquisa"></div>

                <table class="tabela""></table>

            </form>
        </div>
    </div>

    <!--     <div id=" dados">
        </div> -->

        <script>
            const form = document.querySelector("form");
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const repositorio = document.querySelector('#repositorioInput').value;
                const dataInicial = document.querySelector('#dataInicialInput').value;
                const dataFinal = document.querySelector('#dataFinalInput').value;
                buscarCommits(repositorio, dataInicial, dataFinal);

            });

            function buscarCommits(repositorio, dataInicial, dataFinal) {
                var repositorioTratado = tratarCamposUrl(repositorio);
                const url = `https://api.github.com/repos/${repositorioTratado}/commits?since=${dataInicial}&until=${dataFinal}`;
                fetch(url).then(response => response.json()).then(commmits => contarCommmits(commmits))
            }

            function contarCommmits(commits) {
                const commitsPorDia = {};
                commits.forEach(element => {
                    const dataCommit = element.commit.author.date.substr(0, 10);
                    const authorCommit = element.commit.author.name;
                    const messageCommit = element.commit.message;
                    if (commitsPorDia[dataCommit]) {
                        commitsPorDia[dataCommit].quantidade++;
                    } else {
                        commitsPorDia[dataCommit] = { quantidade: 1, data: dataCommit, author: authorCommit, message: messageCommit };
                    }
                });
                console.log(commitsPorDia);

                const commitsPordiaArray = Object.keys(commitsPorDia).map(dataCommit => {
                    return { data: dataCommit, quantidade: commitsPorDia[dataCommit].quantidade, author: commitsPorDia[dataCommit].author, message: commitsPorDia[dataCommit].message };
                })

                criaTabela(commitsPordiaArray);
            }

            function mostrarTela(commits) {
                const dados = document.querySelector(".tabela");
                commits.forEach(element => {
                    const h1 = document.createElement("h1");
                    h1.innerHTML = element.data + " - " + element.quantidade;
                    dados.appendChild(h1);
                });
            }

            function criaTabela(dados) {
                const tabela = document.querySelector(".tabela");


                const colunaData = document.createElement("td");
                const colunaQuantidade = document.createElement("td");
                const colunaAuthor = document.createElement("td");
                const colunaMessagem = document.createElement("td");

                colunaData.textContent = "Data";
                colunaQuantidade.textContent = "Quantidade";
                colunaAuthor.textContent = "Autor";
                colunaMessagem.textContent = "Messagem";


                const cabecalho = document.createElement("tr");
                cabecalho.appendChild(colunaData);
                cabecalho.appendChild(colunaQuantidade);
                cabecalho.appendChild(colunaAuthor);
                cabecalho.appendChild(colunaMessagem);
                tabela.appendChild(cabecalho);

                dados.forEach((commit) => {
                    const linha = document.createElement("tr");

                    const celulaData = document.createElement("td");
                    celulaData.textContent = commit.data;
                    linha.appendChild(celulaData);

                    const celulaQuantidade = document.createElement("td");
                    celulaQuantidade.textContent = commit.quantidade;
                    linha.appendChild(celulaQuantidade);

                    const colunaAuthor = document.createElement("td");
                    colunaAuthor.textContent = commit.author;
                    linha.appendChild(colunaAuthor);

                    const colunaMessagem = document.createElement("td");
                    colunaMessagem.textContent = commit.message;
                    linha.appendChild(colunaMessagem);

                    tabela.appendChild(linha);
                });
            }

            function tratarCamposUrl(url){
                let sizeUrl = url.split('/');
                let usuario = sizeUrl[3];
                let repositorio = sizeUrl[4]
                return usuario + "/" + repositorio
            }

        </script>
</body>

</html>